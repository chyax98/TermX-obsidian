var N=Object.defineProperty;var J=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var ee=Object.prototype.hasOwnProperty;var te=(r,e)=>{for(var t in e)N(r,t,{get:e[t],enumerable:!0})},ie=(r,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Q(e))!ee.call(r,n)&&n!==t&&N(r,n,{get:()=>e[n],enumerable:!(i=J(e,n))||i.enumerable});return r};var ne=r=>ie(N({},"__esModule",{value:!0}),r);var oe={};te(oe,{default:()=>V});module.exports=ne(oe);var B=require("obsidian");var S=require("obsidian");var W=require("obsidian");var _=require("obsidian");function u(r){return r.vault.adapter instanceof _.FileSystemAdapter?r.vault.adapter.getBasePath():""}var k={auto:{},dark:{background:"#1e1e1e",foreground:"#d4d4d4",cursor:"#d4d4d4",black:"#000000",red:"#cd3131",green:"#0dbc79",yellow:"#e5e510",blue:"#2472c8",magenta:"#bc3fbc",cyan:"#11a8cd",white:"#e5e5e5"},light:{background:"#ffffff",foreground:"#383a42",cursor:"#383a42",black:"#000000",red:"#e45649",green:"#50a14f",yellow:"#c18401",blue:"#4078f2",magenta:"#a626a4",cyan:"#0184bc",white:"#fafafa"},dracula:{background:"#282a36",foreground:"#f8f8f2",cursor:"#f8f8f2",black:"#21222c",red:"#ff5555",green:"#50fa7b",yellow:"#f1fa8c",blue:"#bd93f9",magenta:"#ff79c6",cyan:"#8be9fd",white:"#f8f8f2"},monokai:{background:"#272822",foreground:"#f8f8f2",cursor:"#f8f8f2",black:"#272822",red:"#f92672",green:"#a6e22e",yellow:"#f4bf75",blue:"#66d9ef",magenta:"#ae81ff",cyan:"#a1efe4",white:"#f8f8f2"}},x={shell:"",shellArgs:[],fontSize:14,fontFamily:'Menlo, Monaco, "Courier New", monospace',cursorStyle:"block",scrollback:5e3,copyOnSelect:!0,lineHeightScale:.95,defaultCwd:"vault",customCwd:"",theme:"auto"};function C(){return process.platform==="win32"?process.env.COMSPEC||"cmd.exe":process.env.SHELL||"/bin/bash"}function j(r,e){switch(e.defaultCwd){case"vault":return u(r)||process.cwd();case"home":return process.env.HOME||process.env.USERPROFILE||"/";case"custom":return e.customCwd||process.cwd();default:return process.cwd()}}var D=class{constructor(e,t,i){this.pty=null;this.lastNoticeAt=0;this.app=e,this.settings=t,this.pluginDir=i}async spawn(e,t,i,n,a){try{let s=!1,o=l=>{s||(s=!0,t(l))},d;try{let T=require("path").join(this.pluginDir,"node-pty");d=require(T)}catch(l){console.error("[TermX] \u65E0\u6CD5\u52A0\u8F7D node-pty:",l),this.noticeOnce("TermX\uFF1A\u65E0\u6CD5\u52A0\u8F7D node-pty \u6A21\u5757"),e(`\r
[x] \u65E0\u6CD5\u52A0\u8F7D node-pty \u6A21\u5757\r
`),e(`    \u63D2\u4EF6\u76EE\u5F55: ${this.pluginDir}\r
`),e(`    \u53EF\u80FD\u9700\u8981\u9488\u5BF9\u5F53\u524D Electron \u7248\u672C\u91CD\u65B0\u7F16\u8BD1: npx @electron/rebuild\r
`),o(1);return}let p;try{p=require("fs")}catch(l){}let g=(this.settings.shell||"").trim()||C(),m=(a||"").trim()||j(this.app,this.settings);if(p!=null&&p.existsSync)try{if(!p.existsSync(m)){let l=process.env.HOME||process.cwd();e(`\r
[!] \u5DE5\u4F5C\u76EE\u5F55\u4E0D\u5B58\u5728\uFF0C\u5DF2\u56DE\u9000: ${l}\r
`),m=l}}catch(l){}let h=this.settings.shellArgs&&this.settings.shellArgs.length>0?this.settings.shellArgs:this.getDefaultShellArgs(g);this.pty=d.spawn(g,h,{name:"xterm-256color",cols:i,rows:n,cwd:m,env:{...process.env,TERM:"xterm-256color"}}),this.pty.onData(l=>{e(l)}),this.pty.onExit(({exitCode:l})=>{console.log("[TermX] \u8FDB\u7A0B\u9000\u51FA\uFF0C\u4EE3\u7801:",l),o(l)})}catch(s){console.error("[TermX] \u542F\u52A8\u5931\u8D25:",s),this.noticeOnce("TermX\uFF1A\u65E0\u6CD5\u542F\u52A8\u7EC8\u7AEF\uFF0C\u8BF7\u6253\u5F00\u5F00\u53D1\u8005\u63A7\u5236\u53F0\u67E5\u770B\u65E5\u5FD7"),e(`\r
[x] \u65E0\u6CD5\u542F\u52A8 shell: ${s}\r
`),e(`\r
\u63D0\u793A: TermX \u9700\u8981 Obsidian \u684C\u9762\u7248\uFF0C\u4E0D\u652F\u6301\u79FB\u52A8\u7AEF\r
`),t(1)}}write(e){this.pty&&this.pty.write(e)}resize(e,t){if(this.pty)try{this.pty.resize(e,t)}catch(i){}}kill(){this.pty&&(this.pty.kill(),this.pty=null)}get pid(){var e,t;return(t=(e=this.pty)==null?void 0:e.pid)!=null?t:null}getDefaultShellArgs(e){var i,n;let t=(n=(i=e.split(/[\\/]/).pop())==null?void 0:i.toLowerCase())!=null?n:"";return t==="zsh"||t==="bash"||t==="fish"?["-l"]:[]}noticeOnce(e){let t=Date.now();if(!(t-this.lastNoticeAt<2e3)){this.lastNoticeAt=t;try{new W.Notice(e)}catch(i){}}}};function H(r,e){return require("path").join(r,"node_modules",e)}function K(r){return require(H(r,"@xterm/xterm"))}function U(r){return require(H(r,"@xterm/addon-fit"))}function G(r){return require(H(r,"@xterm/addon-search"))}var E=require("obsidian");var P="[\\w./-]",Y=[{name:"http-url",type:"url",pattern:/https?:\/\/[^\s<>"')\]]+/g,extract:(r,e)=>({type:"url",value:r[0],start:e+r.index,end:e+r.index+r[0].length})},{name:"obsidian-protocol",type:"obsidian",pattern:/obsidian:\/\/[^\s<>"')\]]+/g,extract:(r,e)=>({type:"obsidian",value:r[0],start:e+r.index,end:e+r.index+r[0].length})},{name:"wikilink",type:"obsidian",pattern:/\[\[([^\]|]+)(?:\|[^\]]+)?\]\]/g,extract:(r,e)=>({type:"obsidian",value:r[1],start:e+r.index,end:e+r.index+r[0].length})},{name:"email",type:"email",pattern:/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,extract:(r,e)=>({type:"email",value:r[0],start:e+r.index,end:e+r.index+r[0].length})},{name:"file:line:col",type:"file",pattern:new RegExp(`(${P}+\\.\\w+):(\\d+)(?::(\\d+))?`,"g"),extract:(r,e)=>({type:"file",value:r[1],line:parseInt(r[2]),column:r[3]?parseInt(r[3]):void 0,start:e+r.index,end:e+r.index+r[0].length})},{name:"typescript",type:"file",pattern:new RegExp(`(${P}+\\.\\w+)\\((\\d+),(\\d+)\\)`,"g"),extract:(r,e)=>({type:"file",value:r[1],line:parseInt(r[2]),column:parseInt(r[3]),start:e+r.index,end:e+r.index+r[0].length})},{name:"python",type:"file",pattern:/File "([^"]+)", line (\d+)/g,extract:(r,e)=>({type:"file",value:r[1],line:parseInt(r[2]),start:e+r.index,end:e+r.index+r[0].length})},{name:"node-stack",type:"file",pattern:/at (?:\S+ \()?([/\\][\w./\\-]+):(\d+):(\d+)\)?/g,extract:(r,e)=>({type:"file",value:r[1],line:parseInt(r[2]),column:parseInt(r[3]),start:e+r.index+3,end:e+r.index+r[0].length})},{name:"git-status",type:"file",pattern:/(?:modified|deleted|new file):\s+(\S+)/g,extract:(r,e)=>({type:"file",value:r[1],start:e+r.index+r[0].indexOf(r[1]),end:e+r.index+r[0].length})},{name:"relative",type:"file",pattern:new RegExp(`(\\.\\.?/${P}+)`,"g"),extract:(r,e)=>({type:"file",value:r[1],start:e+r.index,end:e+r.index+r[0].length})},{name:"absolute-unix",type:"file",pattern:new RegExp(`(/(?:Users|home|tmp|var|etc)/${P}+\\.\\w+)`,"g"),extract:(r,e)=>({type:"file",value:r[1],start:e+r.index,end:e+r.index+r[0].length})},{name:"windows",type:"file",pattern:/([A-Za-z]:\\[\w.\\-]+)/g,extract:(r,e)=>({type:"file",value:r[1],start:e+r.index,end:e+r.index+r[0].length})}];var L=class{constructor(e){this.terminal=null;this.app=e,this.vaultPath=u(e)}activate(e){this.terminal=e,e.registerLinkProvider({provideLinks:(t,i)=>{let n=e.buffer.active.getLine(t);if(!n){i(void 0);return}let a=n.translateToString(),s=this.findLinks(a,t);i(s.length>0?s:void 0)}})}findLinks(e,t){let i=[];for(let a of Y){a.pattern.lastIndex=0;let s;for(;(s=a.pattern.exec(e))!==null;){let o=a.extract(s,0);o&&i.push(o)}}return this.dedupeMatches(i).map(a=>({range:{start:{x:a.start+1,y:t+1},end:{x:a.end+1,y:t+1}},text:a.value,activate:()=>this.handleClick(a)}))}dedupeMatches(e){let t=e.sort((n,a)=>n.start-a.start),i=[];for(let n of t){let a=i[i.length-1];(!a||n.start>=a.end)&&i.push(n)}return i}async handleClick(e){let{shell:t}=require("electron");switch(e.type){case"url":t.openExternal(e.value);break;case"email":t.openExternal(`mailto:${e.value}`);break;case"obsidian":e.value.startsWith("obsidian://")?window.open(e.value):await this.app.workspace.openLinkText(e.value,"",!1);break;case"file":await this.handleFileClick(e);break}}async handleFileClick(e){let t=this.resolveToVaultFile(e.value);if(t){if(await this.app.workspace.getLeaf(!1).openFile(t),e.line){let n=this.app.workspace.getActiveViewOfType(E.MarkdownView);if(n!=null&&n.editor){let a=e.line-1,s=(e.column||1)-1;n.editor.setCursor({line:a,ch:s}),n.editor.scrollIntoView({from:{line:a,ch:0},to:{line:a,ch:0}},!0)}}}else{let{shell:i}=require("electron");i.openPath(e.value)}}resolveToVaultFile(e){let t=e;e.startsWith(this.vaultPath)&&(t=e.slice(this.vaultPath.length).replace(/^[\/\\]/,""));let i=this.app.vault.getAbstractFileByPath(t);if(i instanceof E.TFile)return i;let n=this.app.vault.getAbstractFileByPath(t+".md");return n instanceof E.TFile?n:null}dispose(){this.terminal=null}};var M=class{constructor(e,t,i,n){this.handleDragOver=e=>this.onDragOver(e);this.handleDrop=e=>{this.onDrop(e)};this.handleDragLeave=e=>this.onDragLeave(e);this.terminal=e,this.container=t,this.app=i,this.writeToShell=n,this.vaultPath=u(i),this.setup()}setup(){this.container.addEventListener("dragover",this.handleDragOver),this.container.addEventListener("drop",this.handleDrop),this.container.addEventListener("dragleave",this.handleDragLeave)}onDragOver(e){e.preventDefault(),e.stopPropagation(),this.container.classList.add("terminal-drag-over"),e.dataTransfer&&(e.dataTransfer.dropEffect="copy")}onDragLeave(e){this.container.classList.remove("terminal-drag-over")}async onDrop(e){if(e.preventDefault(),e.stopPropagation(),this.container.classList.remove("terminal-drag-over"),!e.dataTransfer)return;let t=[];if(e.dataTransfer.files.length>0){let i=null;try{i=require("electron").webUtils}catch(n){}for(let n=0;n<e.dataTransfer.files.length;n++){let a=e.dataTransfer.files[n],s=null;if(i!=null&&i.getPathForFile)try{s=i.getPathForFile(a)}catch(o){}!s&&a.path&&(s=a.path),s&&t.push(s)}}if(t.length===0){let i=e.dataTransfer.getData("text/plain");if(i){let n=this.parseObsidianDrag(i);n&&t.push(this.getFullPath(n))}}if(t.length>0){let i=t.map(n=>this.escapePath(n)).join(" ");this.writeToShell(i)}}parseObsidianDrag(e){if(e.startsWith("obsidian://"))try{let i=new URL(e).searchParams.get("file");if(i){let n=decodeURIComponent(i);return this.findFileByPath(n)}}catch(t){}return this.findFileByPath(e)}findFileByPath(e){let t=this.app.vault.getAbstractFileByPath(e);if(t||(t=this.app.vault.getAbstractFileByPath(e+".md"),t))return t.path;let i=this.app.vault.getAllLoadedFiles();for(let n of i)if(n.name===e||n.name===e+".md")return n.path;return null}getFullPath(e){return require("path").join(this.vaultPath,e)}escapePath(e){return process.platform==="win32"?e.includes(" ")||e.includes("&")||e.includes("^")?`"${e}"`:e:e.includes("'")?`'${e.replace(/'/g,"'\\''")}'`:`'${e}'`}destroy(){this.container.removeEventListener("dragover",this.handleDragOver),this.container.removeEventListener("drop",this.handleDrop),this.container.removeEventListener("dragleave",this.handleDragLeave)}};var f=require("obsidian"),F=class{constructor(e,t,i){this.terminal=e,this.app=t,this.getCursorState=i}getSelection(){return this.terminal.getSelection()}getAllOutput(){let e=this.terminal.buffer.active,t=[];for(let i=0;i<e.length;i++){let n=e.getLine(i);n&&t.push(n.translateToString())}return t.join(`
`)}async sendToNewNote(e){let t=e||this.getSelection();if(!t){new f.Notice("No content selected");return}let i=`Terminal Output ${Date.now()}.md`,n=this.wrapAsCodeBlock(t),a=await this.app.vault.create(i,n);await this.app.workspace.openLinkText(a.path,"",!0),new f.Notice(`Created: ${i}`)}async appendToCurrentNote(e){var m;let t=e||this.getSelection();if(!t){new f.Notice("\u6CA1\u6709\u9009\u4E2D\u5185\u5BB9");return}let i=null,n=null,a=this.getCursorState();if(a){let h=this.app.workspace.getLeavesOfType("markdown");for(let l of h){let T=l.view;if(((m=T.file)==null?void 0:m.path)===a.filePath){i=T,n=a.cursor;break}}}if(i||(i=this.app.workspace.getActiveViewOfType(f.MarkdownView)),!i){let h=this.app.workspace.getLeavesOfType("markdown");h.length>0&&(i=h[0].view)}if(!i){new f.Notice("\u6CA1\u6709\u6253\u5F00\u7684\u7B14\u8BB0");return}let s=i.editor,o=s.getValue(),d="<!-- terminal-output -->",p=o.indexOf(d),g=this.wrapAsCodeBlock(t);if(p!==-1){let h=s.offsetToPos(p+d.length);s.replaceRange(`
`+g+`
`,h),new f.Notice("\u5DF2\u63D2\u5165\u5230\u6807\u8BB0\u4F4D\u7F6E")}else{let h=n||s.getCursor();s.replaceRange(`
`+g+`
`,h),new f.Notice("\u5DF2\u63D2\u5165\u5230\u5149\u6807\u4F4D\u7F6E")}this.app.workspace.setActiveLeaf(i.leaf,{focus:!0})}wrapAsCodeBlock(e){return"```\n"+e.trim()+"\n```"}};function y(r,e,t){try{let i=document.createElement("div");i.style.position="absolute",i.style.left="-99999px",i.style.top="0",i.style.pointerEvents="none",t==="background"?i.style.backgroundColor=`var(${r}, ${e})`:i.style.color=`var(${r}, ${e})`,document.body.appendChild(i);let n=getComputedStyle(i),a=t==="background"?n.backgroundColor:n.color;return i.remove(),(a||"").trim()||e}catch(i){return e}}function re(r,e){try{let t=document.createElement("div");t.style.position="absolute",t.style.left="-99999px",t.style.top="0",t.style.pointerEvents="none",t.style.fontFamily=`var(${r}, ${e})`,document.body.appendChild(t);let n=getComputedStyle(t).fontFamily||"";return t.remove(),n.trim()||e}catch(t){return e}}function ae(r,e,t,i){try{let n=document.createElement("div");n.style.position="absolute",n.style.left="-99999px",n.style.top="0",n.style.pointerEvents="none",n.style.fontFamily=e,n.style.fontSize=`${t}px`,n.style.lineHeight=`var(${r}, ${i})`,document.body.appendChild(n);let a=getComputedStyle(n),s=parseFloat(a.lineHeight||""),o=parseFloat(a.fontSize||"");if(n.remove(),!Number.isFinite(s)||!Number.isFinite(o)||o<=0)return i;let d=s/o;return!Number.isFinite(d)||d<=0?i:Math.min(Math.max(d,1),2)}catch(n){return i}}function Z(){let r=document.body.classList.contains("theme-dark"),e=y("--text-selection",r?"rgba(255,255,255,0.35)":"rgba(0,0,0,0.25)","background"),t=y("--text-on-accent",r?"#1e1e1e":"#ffffff","color");return r?{background:y("--background-primary","#1e1e1e","background"),foreground:y("--text-normal","#d4d4d4","color"),cursor:y("--text-normal","#d4d4d4","color"),selectionBackground:e,selectionForeground:t,black:"#000000",red:"#cd3131",green:"#0dbc79",yellow:"#e5e510",blue:"#2472c8",magenta:"#bc3fbc",cyan:"#11a8cd",white:"#e5e5e5",brightBlack:"#666666",brightRed:"#f14c4c",brightGreen:"#23d18b",brightYellow:"#f5f543",brightBlue:"#3b8eea",brightMagenta:"#d670d6",brightCyan:"#29b8db",brightWhite:"#ffffff"}:{background:y("--background-primary","#fafafa","background"),foreground:y("--text-normal","#383a42","color"),cursor:y("--text-normal","#383a42","color"),selectionBackground:e,selectionForeground:t,black:"#000000",red:"#e45649",green:"#50a14f",yellow:"#c18401",blue:"#4078f2",magenta:"#a626a4",cyan:"#0184bc",white:"#fafafa",brightBlack:"#4a4a4a",brightRed:"#e06c75",brightGreen:"#98c379",brightYellow:"#d19a66",brightBlue:"#61afef",brightMagenta:"#c678dd",brightCyan:"#56b6c2",brightWhite:"#ffffff"}}var O=class{constructor(e,t,i,n,a,s){this.dragDropHandler=null;this.onDataDisposable=null;this.onResizeDisposable=null;this.onSelectionDisposable=null;this.pasteHandler=null;this.exited=!1;this.cwdOverride=null;var $;this.id=a,this.app=e,this.settings=t,this.pluginDir=i,this.getCursorState=n,this.cwdOverride=s!=null?s:null;let o=t.theme==="auto"?Z():k[t.theme]||k.dark,{Terminal:d}=K(this.pluginDir),{FitAddon:p}=U(this.pluginDir),{SearchAddon:g}=G(this.pluginDir),m=re("--font-monospace",(($=t.fontFamily)==null?void 0:$.trim())||x.fontFamily),h=ae("--line-height-normal",m,t.fontSize,1.15),l=Math.min(Math.max(t.lineHeightScale||1,.8),1.2),T=h*l;this.terminal=new d({fontSize:t.fontSize,fontFamily:m,cursorStyle:t.cursorStyle,cursorBlink:!0,scrollback:t.scrollback,theme:o,letterSpacing:0,lineHeight:T}),this.fitAddon=new p,this.searchAddon=new g,this.pathLinker=new L(e),this.ptyManager=new D(e,t,i),this.terminal.loadAddon(this.fitAddon),this.terminal.loadAddon(this.searchAddon),this.terminal.loadAddon(this.pathLinker),this.contentBridge=new F(this.terminal,e,this.getCursorState),this.terminal.attachCustomKeyEventHandler(v=>{if(v.type!=="keydown")return!0;if(v.metaKey&&v.key==="Backspace")return this.ptyManager.write(""),!1;if(!v.metaKey)return!0;let q=v.key.toLowerCase();if(q==="c"){let X=this.terminal.getSelection();return X?(navigator.clipboard.writeText(X).catch(()=>null),!1):!0}return q==="k"?(this.ptyManager.write("\f"),!1):!0}),this.onSelectionDisposable=this.terminal.onSelectionChange(()=>{if(!this.settings.copyOnSelect)return;let v=this.terminal.getSelection();v&&navigator.clipboard.writeText(v).catch(()=>null)})}async mount(e){this.container=e,this.terminal.open(e),this.fitAddon.fit(),e.addEventListener("mouseup",t=>{this.terminal.getSelection()||(t.target===e||e.contains(t.target))&&this.terminal.focus()}),this.pasteHandler=t=>{t.preventDefault(),t.stopPropagation()},e.addEventListener("paste",this.pasteHandler),this.dragDropHandler=new M(this.terminal,e,this.app,t=>this.ptyManager.write(t)),await this.startPty()}async startPty(){var i;let{cols:e,rows:t}=this.terminal;this.onDataDisposable&&(this.onDataDisposable.dispose(),this.onDataDisposable=null),this.onResizeDisposable&&(this.onResizeDisposable.dispose(),this.onResizeDisposable=null),await this.ptyManager.spawn(n=>this.terminal.write(n),n=>{this.exited=!0,this.terminal.writeln(`\r
[\u8FDB\u7A0B\u5DF2\u9000\u51FA: ${n}]`)},e,t,(i=this.cwdOverride)!=null?i:void 0),this.onDataDisposable=this.terminal.onData(n=>this.ptyManager.write(n)),this.onResizeDisposable=this.terminal.onResize(({cols:n,rows:a})=>this.ptyManager.resize(n,a))}applySettings(e){this.settings=e,this.terminal.options.fontSize=e.fontSize,this.terminal.options.fontFamily=e.fontFamily,this.terminal.options.cursorStyle=e.cursorStyle,this.terminal.options.scrollback=e.scrollback;let t=e.theme==="auto"?Z():k[e.theme]||k.dark;this.terminal.options.theme=t,this.fitAddon.fit()}async restart(e){typeof e!="undefined"&&(this.cwdOverride=e),this.exited=!1,this.ptyManager.kill(),this.terminal.reset(),await this.startPty(),this.terminal.focus()}fit(){this.fitAddon.fit()}writeToShell(e){this.ptyManager.write(e)}show(){var e;(e=this.container)==null||e.classList.remove("hidden"),this.fit(),this.terminal.focus()}hide(){var e;(e=this.container)==null||e.classList.add("hidden")}isExited(){return this.exited}dispose(){var e,t,i,n,a;this.ptyManager.kill(),(e=this.dragDropHandler)==null||e.destroy(),(t=this.onDataDisposable)==null||t.dispose(),(i=this.onResizeDisposable)==null||i.dispose(),(n=this.onSelectionDisposable)==null||n.dispose(),this.pasteHandler&&this.container&&this.container.removeEventListener("paste",this.pasteHandler),this.pathLinker.dispose(),this.terminal.dispose(),(a=this.container)==null||a.remove()}};var b="integrated-terminal",R=class extends S.Modal{constructor(e,t){super(e),this.onSearch=t}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("terminal-search-modal");let t=e.createDiv({cls:"terminal-search-input-container"});this.inputEl=t.createEl("input",{type:"text",placeholder:"\u641C\u7D22\u7EC8\u7AEF\u5185\u5BB9...",cls:"terminal-search-input"}),this.inputEl.style.width="100%",this.inputEl.style.padding="8px",this.inputEl.style.marginBottom="10px";let i=e.createDiv({cls:"terminal-search-btns"});i.style.display="flex",i.style.gap="8px";let n=i.createEl("button",{text:"\u4E0A\u4E00\u4E2A"}),a=i.createEl("button",{text:"\u4E0B\u4E00\u4E2A",cls:"mod-cta"});n.onclick=()=>this.doSearch("prev"),a.onclick=()=>this.doSearch("next"),this.inputEl.addEventListener("keydown",s=>{s.key==="Enter"&&(s.preventDefault(),this.doSearch(s.shiftKey?"prev":"next"))}),this.inputEl.focus()}doSearch(e){let t=this.inputEl.value.trim();t&&this.onSearch(t,e)}onClose(){this.contentEl.empty()}},A=class extends S.ItemView{constructor(t,i,n,a,s){super(t);this.tabs=[];this.activeTab=null;this.tabBar=null;this.terminalArea=null;this.resizeObserver=null;this.getInitialCwd=null;this.bodyClassObserver=null;this.settings=i,this.pluginDir=n,this.getCursorState=a,this.getInitialCwd=s!=null?s:null}getNextTabId(){let t=new Set(this.tabs.map(n=>n.id)),i=1;for(;t.has(i);)i++;return i}getViewType(){return b}getDisplayText(){return"\u7EC8\u7AEF"}getIcon(){return"terminal-square"}async onOpen(){var n,a;let t=this.containerEl.children[1];t.empty(),t.addClass("terminal-view-container"),this.tabBar=t.createDiv({cls:"terminal-tab-bar"}),this.terminalArea=t.createDiv({cls:"terminal-area"}),this.resizeObserver=new ResizeObserver(()=>{var s;return(s=this.activeTab)==null?void 0:s.fit()}),this.resizeObserver.observe(this.terminalArea),this.bodyClassObserver=new MutationObserver(()=>{this.settings.theme==="auto"&&this.tabs.forEach(s=>s.applySettings(this.settings))}),this.bodyClassObserver.observe(document.body,{attributes:!0,attributeFilter:["class"]});let i=(a=(n=this.getInitialCwd)==null?void 0:n.call(this))!=null?a:null;await this.createTab(i!=null?i:void 0)}getCurrentFileCwd(){var a;let t=this.app.workspace.getActiveFile();if(!t)return null;let i=((a=t.parent)==null?void 0:a.path)||"",n=u(this.app);return n?require("path").join(n,i):null}async createTab(t){if(!this.terminalArea)return;let i=this.getNextTabId(),n=new O(this.app,this.settings,this.pluginDir,this.getCursorState,i,t!=null?t:null);this.tabs.push(n);let a=this.terminalArea.createDiv({cls:"terminal-wrapper"});await n.mount(a),this.setupContextMenu(n,a),this.switchTab(n),this.renderTabBar()}switchTab(t){this.tabs.forEach(i=>i.hide()),t.show(),this.activeTab=t}renderTabBar(){if(!this.tabBar)return;this.tabBar.empty();let t=this.tabBar.createDiv({cls:"terminal-tabs"}),i=this.tabs.length>1;this.tabs.forEach(s=>{let o=t.createDiv({cls:"terminal-tab"});s===this.activeTab&&o.addClass("active");let d=o.createSpan({text:`\u7EC8\u7AEF ${s.id}`});if(s.isExited()&&d.addClass("exited"),o.onclick=()=>{this.switchTab(s),this.renderTabBar()},i){let p=o.createSpan({text:"\xD7",cls:"tab-close"});p.onclick=g=>{g.stopPropagation(),this.closeTab(s)}}});let n=t.createDiv({cls:"terminal-tab-add"});n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',n.title="\u65B0\u5EFA\u6807\u7B7E",n.onclick=()=>void this.createTab();let a=this.tabBar.createDiv({cls:"terminal-tab-search"});a.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>',a.title="\u641C\u7D22",a.onclick=()=>this.showSearch()}closeTab(t){if(this.tabs.length<=1)return;let i=this.tabs.indexOf(t);i!==-1&&(t.dispose(),this.tabs.splice(i,1),t===this.activeTab&&this.switchTab(this.tabs[Math.min(i,this.tabs.length-1)]),this.renderTabBar())}setupContextMenu(t,i){i.addEventListener("contextmenu",n=>{n.preventDefault();let a=new S.Menu;a.addItem(s=>s.setTitle("\u590D\u5236").setIcon("copy").onClick(()=>{let o=t.terminal.getSelection();o&&navigator.clipboard.writeText(o)})),a.addItem(s=>s.setTitle("\u7C98\u8D34").setIcon("clipboard-paste").onClick(async()=>{let o=await navigator.clipboard.readText();t.writeToShell(o)})),a.addSeparator(),a.addItem(s=>s.setTitle("\u6E05\u5C4F").setIcon("trash-2").onClick(()=>{t.terminal.clear()})),a.addItem(s=>s.setTitle("\u641C\u7D22").setIcon("search").onClick(()=>{this.showSearch()})),a.addSeparator(),a.addItem(s=>s.setTitle("\u5728\u5F53\u524D\u6587\u4EF6\u76EE\u5F55\u65B0\u5EFA").setIcon("folder-plus").onClick(()=>{let o=this.getCurrentFileCwd();this.createTab(o!=null?o:void 0)})),a.addItem(s=>s.setTitle("\u91CD\u542F\u7EC8\u7AEF").setIcon("refresh-cw").onClick(()=>{this.restartCurrentTab()})),a.addSeparator(),a.addItem(s=>s.setTitle("\u9009\u4E2D\u2192\u65B0\u7B14\u8BB0").setIcon("file-plus").onClick(()=>{t.contentBridge.sendToNewNote()})),a.addItem(s=>s.setTitle("\u9009\u4E2D\u2192\u5F53\u524D\u7B14\u8BB0").setIcon("file-input").onClick(()=>{t.contentBridge.appendToCurrentNote()})),a.showAtMouseEvent(n)})}showSearch(){new R(this.app,(t,i)=>{var n,a;i==="next"?(n=this.activeTab)==null||n.searchAddon.findNext(t):(a=this.activeTab)==null||a.searchAddon.findPrevious(t)}).open()}async createNewTab(t){await this.createTab(t)}async restartCurrentTab(){this.activeTab&&await this.activeTab.restart()}updateSettings(t){this.settings=t,this.tabs.forEach(i=>i.applySettings(t))}closeCurrentTab(){this.activeTab&&this.closeTab(this.activeTab)}clearTerminal(){var t;(t=this.activeTab)==null||t.terminal.clear()}sendToTerminal(t){!t||!this.activeTab||this.activeTab.writeToShell(t)}sendSelectionToNote(){var t;(t=this.activeTab)==null||t.contentBridge.appendToCurrentNote()}async onClose(){var t,i;(t=this.resizeObserver)==null||t.disconnect(),(i=this.bodyClassObserver)==null||i.disconnect(),this.tabs.forEach(n=>n.dispose())}};var c=require("obsidian");var w="var(--font-monospace, monospace)",z={system:{label:"\u8DDF\u968F Obsidian (\u7B49\u5BBD\u5B57\u4F53)",stack:w},sfmono:{label:"SF Mono (macOS)",stack:`'SF Mono', ${w}`},menlo:{label:"Menlo",stack:`'Menlo', ${w}`},monaco:{label:"Monaco",stack:`'Monaco', ${w}`},jetbrains:{label:"JetBrains Mono",stack:`'JetBrains Mono', ${w}`},firacode:{label:"Fira Code",stack:`'Fira Code', ${w}`},cascadia:{label:"Cascadia Code",stack:`'Cascadia Code', ${w}`},sourcecodepro:{label:"Source Code Pro",stack:`'Source Code Pro', ${w}`}};function se(r){let e=(r||"").trim();for(let[t,i]of Object.entries(z))if(i.stack===e)return t;return e==='Menlo, Monaco, "Courier New", monospace'?"menlo":e===""||e==="monospace"?"system":"menlo"}var I=class extends c.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h3",{text:"\u5916\u89C2"}),new c.Setting(e).setName("\u914D\u8272\u4E3B\u9898").addDropdown(t=>t.addOption("auto","\u8DDF\u968F Obsidian").addOption("dark","\u6DF1\u8272").addOption("light","\u6D45\u8272").addOption("dracula","Dracula").addOption("monokai","Monokai").setValue(this.plugin.settings.theme).onChange(async i=>{this.plugin.settings.theme=i,await this.plugin.saveSettings()})),new c.Setting(e).setName("\u5B57\u4F53").addDropdown(t=>{for(let[i,n]of Object.entries(z))t.addOption(i,n.label);t.setValue(se(this.plugin.settings.fontFamily)).onChange(async i=>{let n=z[i];n&&(this.plugin.settings.fontFamily=n.stack,await this.plugin.saveSettings())})}),new c.Setting(e).setName("\u5B57\u4F53\u5927\u5C0F").addSlider(t=>t.setLimits(10,24,1).setValue(this.plugin.settings.fontSize).setDynamicTooltip().onChange(async i=>{this.plugin.settings.fontSize=i,await this.plugin.saveSettings()})),new c.Setting(e).setName("\u5149\u6807\u6837\u5F0F").addDropdown(t=>t.addOption("block","\u65B9\u5757").addOption("underline","\u4E0B\u5212\u7EBF").addOption("bar","\u7AD6\u7EBF").setValue(this.plugin.settings.cursorStyle).onChange(async i=>{this.plugin.settings.cursorStyle=i,await this.plugin.saveSettings()})),new c.Setting(e).setName("\u884C\u9AD8\u6BD4\u4F8B").setDesc("\u57FA\u4E8E Obsidian \u884C\u9AD8\u7684\u7F29\u653E\u7CFB\u6570\uFF0C\u5EFA\u8BAE\u8303\u56F4 0.90-1.05").addSlider(t=>t.setLimits(.85,1.2,.01).setValue(this.plugin.settings.lineHeightScale).setDynamicTooltip().onChange(async i=>{this.plugin.settings.lineHeightScale=i,await this.plugin.saveSettings()})),e.createEl("h3",{text:"\u884C\u4E3A"}),new c.Setting(e).setName("\u9009\u4E2D\u81EA\u52A8\u590D\u5236").setDesc("\u9009\u4E2D\u6587\u672C\u65F6\u81EA\u52A8\u590D\u5236\u5230\u526A\u8D34\u677F").addToggle(t=>t.setValue(this.plugin.settings.copyOnSelect).onChange(async i=>{this.plugin.settings.copyOnSelect=i,await this.plugin.saveSettings()})),new c.Setting(e).setName("\u6EDA\u52A8\u7F13\u51B2\u884C\u6570").setDesc("\u7EC8\u7AEF\u4FDD\u7559\u7684\u5386\u53F2\u884C\u6570").addSlider(t=>t.setLimits(1e3,5e4,1e3).setValue(this.plugin.settings.scrollback).setDynamicTooltip().onChange(async i=>{this.plugin.settings.scrollback=i,await this.plugin.saveSettings()})),e.createEl("h3",{text:"\u542F\u52A8"}),e.createEl("p",{text:"\u4EE5\u4E0B\u8BBE\u7F6E\u9700\u8981\u91CD\u542F\u7EC8\u7AEF\u6216\u65B0\u5EFA\u6807\u7B7E\u624D\u4F1A\u751F\u6548",cls:"setting-item-description"}),new c.Setting(e).setName("Shell \u7A0B\u5E8F").setDesc(`\u7559\u7A7A\u4F7F\u7528\u7CFB\u7EDF\u9ED8\u8BA4: ${C()}`).addText(t=>{t.inputEl.style.width="200px",t.setPlaceholder(C()).setValue(this.plugin.settings.shell).onChange(async i=>{this.plugin.settings.shell=i,await this.plugin.saveSettings()})}),new c.Setting(e).setName("\u9ED8\u8BA4\u5DE5\u4F5C\u76EE\u5F55").addDropdown(t=>t.addOption("vault","Vault \u6839\u76EE\u5F55").addOption("home","\u7528\u6237\u4E3B\u76EE\u5F55").addOption("custom","\u81EA\u5B9A\u4E49\u8DEF\u5F84").setValue(this.plugin.settings.defaultCwd).onChange(async i=>{this.plugin.settings.defaultCwd=i,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.defaultCwd==="custom"&&new c.Setting(e).setName("\u81EA\u5B9A\u4E49\u8DEF\u5F84").addText(t=>t.setPlaceholder("/path/to/directory").setValue(this.plugin.settings.customCwd).onChange(async i=>{this.plugin.settings.customCwd=i,await this.plugin.saveSettings()})),new c.Setting(e).addButton(t=>t.setButtonText("\u91CD\u542F\u5F53\u524D\u7EC8\u7AEF").onClick(async()=>{await this.plugin.restartActiveTerminal()}))}};var V=class extends B.Plugin{constructor(){super(...arguments);this.settings=x;this.pendingInitialCwd=null;this.lastCursorState=null;this.cursorTrackEvents=[]}getPluginDir(){return require("path").join(u(this.app),".obsidian","plugins",this.manifest.id)}async onload(){await this.loadSettings();let t=this.getPluginDir();this.setupCursorTracking(),this.registerView(b,i=>new A(i,this.settings,t,()=>this.lastCursorState,()=>this.consumePendingInitialCwd())),this.addCommand({id:"open-terminal",name:"\u6253\u5F00\u7EC8\u7AEF",callback:()=>this.activateView()}),this.addCommand({id:"toggle-terminal",name:"\u5207\u6362\u7EC8\u7AEF (\u663E\u793A/\u9690\u85CF)",callback:()=>this.toggleTerminal()}),this.addCommand({id:"open-terminal-here",name:"\u5728\u5F53\u524D\u6587\u4EF6\u76EE\u5F55\u6253\u5F00\u7EC8\u7AEF",callback:()=>this.openTerminalAtCurrentFile()}),this.addCommand({id:"send-selection-to-terminal",name:"\u53D1\u9001\u9009\u4E2D\u5185\u5BB9\u5230\u7EC8\u7AEF",editorCallback:i=>{let n=i.getSelection();n&&this.sendToTerminal(n)}}),this.addCommand({id:"new-terminal-tab",name:"\u65B0\u5EFA\u7EC8\u7AEF\u6807\u7B7E",callback:()=>{var i;return(i=this.getTerminalView())==null?void 0:i.createNewTab()}}),this.addCommand({id:"close-terminal-tab",name:"\u5173\u95ED\u5F53\u524D\u7EC8\u7AEF\u6807\u7B7E",callback:()=>{var i;return(i=this.getTerminalView())==null?void 0:i.closeCurrentTab()}}),this.addCommand({id:"clear-terminal",name:"\u6E05\u5C4F",callback:()=>{var i;return(i=this.getTerminalView())==null?void 0:i.clearTerminal()}}),this.addCommand({id:"terminal-search",name:"\u7EC8\u7AEF\u641C\u7D22",callback:()=>{var i;return(i=this.getTerminalView())==null?void 0:i.showSearch()}}),this.addCommand({id:"terminal-selection-to-note",name:"\u7EC8\u7AEF\u9009\u4E2D\u5185\u5BB9 \u2192 \u5F53\u524D\u7B14\u8BB0",callback:()=>{var i;return(i=this.getTerminalView())==null?void 0:i.sendSelectionToNote()}}),this.registerEvent(this.app.workspace.on("editor-menu",(i,n)=>{let a=n.getSelection();a&&i.addItem(s=>{s.setTitle("\u53D1\u9001\u5230\u7EC8\u7AEF").setIcon("terminal").onClick(()=>this.sendToTerminal(a))})})),this.addSettingTab(new I(this.app,this)),this.addRibbonIcon("terminal-square","\u6253\u5F00\u7EC8\u7AEF",()=>this.activateView())}async activateView(){let{workspace:t}=this.app,i=t.getLeavesOfType(b)[0];if(!i){let n=t.getRightLeaf(!1);n&&(i=n,await i.setViewState({type:b,active:!0}))}i&&t.revealLeaf(i)}async openTerminalAtCurrentFile(){var s;let t=this.app.workspace.getActiveFile();if(!t){await this.activateView();return}let i=((s=t.parent)==null?void 0:s.path)||"",n=require("path").join(u(this.app),i),a=this.getTerminalView();if(a){await this.activateView(),await a.createNewTab(n);return}this.pendingInitialCwd=n,await this.activateView()}sendToTerminal(t){let i=this.getTerminalView();i&&i.sendToTerminal(t)}getTerminalView(){let t=this.app.workspace.getLeavesOfType(b);return t.length>0?t[0].view:null}async toggleTerminal(){let t=this.app.workspace.getLeavesOfType(b);if(t.length>0){let i=t[0];this.app.workspace.getActiveViewOfType(A)!==null?i.detach():this.app.workspace.revealLeaf(i)}else await this.activateView()}async loadSettings(){this.settings=Object.assign({},x,await this.loadData()),this.settings.lineHeightScale||(this.settings.lineHeightScale=x.lineHeightScale)}async saveSettings(){await this.saveData(this.settings),this.applySettingsToViews()}applySettingsToViews(){let t=this.app.workspace.getLeavesOfType(b);for(let i of t)i.view.updateSettings(this.settings)}async restartActiveTerminal(){var t;await((t=this.getTerminalView())==null?void 0:t.restartCurrentTab())}consumePendingInitialCwd(){let t=this.pendingInitialCwd;return this.pendingInitialCwd=null,t}setupCursorTracking(){let t=()=>{let i=this.app.workspace.getActiveViewOfType(B.MarkdownView);i!=null&&i.file&&(this.lastCursorState={filePath:i.file.path,cursor:i.editor.getCursor()})};this.cursorTrackEvents.push(this.app.workspace.on("active-leaf-change",()=>{setTimeout(t,10)})),this.cursorTrackEvents.push(this.app.workspace.on("editor-change",t))}onunload(){this.cursorTrackEvents.forEach(t=>this.app.workspace.offref(t)),this.cursorTrackEvents=[]}};
