var H=Object.defineProperty;var ee=Object.getOwnPropertyDescriptor;var te=Object.getOwnPropertyNames;var ie=Object.prototype.hasOwnProperty;var ne=(s,t)=>{for(var e in t)H(s,e,{get:t[e],enumerable:!0})},se=(s,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of te(t))!ie.call(s,n)&&n!==e&&H(s,n,{get:()=>t[n],enumerable:!(i=ee(t,n))||i.enumerable});return s};var ae=s=>se(H({},"__esModule",{value:!0}),s);var oe={};ne(oe,{default:()=>O});module.exports=ae(oe);var B=require("obsidian");var x=require("obsidian");var W=require("obsidian");var _=require("obsidian");function u(s){return s.vault.adapter instanceof _.FileSystemAdapter?s.vault.adapter.getBasePath():""}var k={auto:{},dark:{background:"#1e1e1e",foreground:"#d4d4d4",cursor:"#d4d4d4",black:"#000000",red:"#cd3131",green:"#0dbc79",yellow:"#e5e510",blue:"#2472c8",magenta:"#bc3fbc",cyan:"#11a8cd",white:"#e5e5e5"},light:{background:"#ffffff",foreground:"#383a42",cursor:"#383a42",black:"#000000",red:"#e45649",green:"#50a14f",yellow:"#c18401",blue:"#4078f2",magenta:"#a626a4",cyan:"#0184bc",white:"#fafafa"},dracula:{background:"#282a36",foreground:"#f8f8f2",cursor:"#f8f8f2",black:"#21222c",red:"#ff5555",green:"#50fa7b",yellow:"#f1fa8c",blue:"#bd93f9",magenta:"#ff79c6",cyan:"#8be9fd",white:"#f8f8f2"},monokai:{background:"#272822",foreground:"#f8f8f2",cursor:"#f8f8f2",black:"#272822",red:"#f92672",green:"#a6e22e",yellow:"#f4bf75",blue:"#66d9ef",magenta:"#ae81ff",cyan:"#a1efe4",white:"#f8f8f2"}},w={shell:"",shellArgs:[],fontSize:14,fontFamily:'Menlo, Monaco, "Courier New", monospace',cursorStyle:"block",scrollback:5e3,copyOnSelect:!0,lineHeightScale:.95,defaultCwd:"vault",customCwd:"",theme:"auto",restoreSession:!0};function C(){return process.platform==="win32"?process.env.COMSPEC||"cmd.exe":process.env.SHELL||"/bin/bash"}function j(s,t){switch(t.defaultCwd){case"vault":return u(s)||process.cwd();case"home":return process.env.HOME||process.env.USERPROFILE||"/";case"custom":return t.customCwd||process.cwd();default:return process.cwd()}}var P=class{constructor(t,e,i){this.pty=null;this.lastNoticeAt=0;this.app=t,this.settings=e,this.pluginDir=i}async spawn(t,e,i,n,a){try{let r=!1,o=l=>{r||(r=!0,e(l))},c;try{let S=require("path").join(this.pluginDir,"node_modules","node-pty");c=require(S)}catch(l){console.error("[TermX] \u65E0\u6CD5\u52A0\u8F7D node-pty:",l),this.noticeOnce("TermX\uFF1A\u65E0\u6CD5\u52A0\u8F7D node-pty \u6A21\u5757"),t(`\r
[x] \u65E0\u6CD5\u52A0\u8F7D node-pty \u6A21\u5757\r
`),t(`    \u63D2\u4EF6\u76EE\u5F55: ${this.pluginDir}\r
`),t(`    \u53EF\u80FD\u9700\u8981\u9488\u5BF9\u5F53\u524D Electron \u7248\u672C\u91CD\u65B0\u7F16\u8BD1: npx @electron/rebuild\r
`),o(1);return}let h;try{h=require("fs")}catch(l){}let g=(this.settings.shell||"").trim()||C(),m=(a||"").trim()||j(this.app,this.settings);if(h!=null&&h.existsSync)try{if(!h.existsSync(m)){let l=process.env.HOME||process.cwd();t(`\r
[!] \u5DE5\u4F5C\u76EE\u5F55\u4E0D\u5B58\u5728\uFF0C\u5DF2\u56DE\u9000: ${l}\r
`),m=l}}catch(l){}let p=this.settings.shellArgs&&this.settings.shellArgs.length>0?this.settings.shellArgs:this.getDefaultShellArgs(g);this.pty=c.spawn(g,p,{name:"xterm-256color",cols:i,rows:n,cwd:m,env:{...process.env,TERM:"xterm-256color"}}),this.pty.onData(l=>{t(l)}),this.pty.onExit(({exitCode:l})=>{console.log("[TermX] \u8FDB\u7A0B\u9000\u51FA\uFF0C\u4EE3\u7801:",l),o(l)})}catch(r){console.error("[TermX] \u542F\u52A8\u5931\u8D25:",r),this.noticeOnce("TermX\uFF1A\u65E0\u6CD5\u542F\u52A8\u7EC8\u7AEF\uFF0C\u8BF7\u6253\u5F00\u5F00\u53D1\u8005\u63A7\u5236\u53F0\u67E5\u770B\u65E5\u5FD7"),t(`\r
[x] \u65E0\u6CD5\u542F\u52A8 shell: ${r}\r
`),t(`\r
\u63D0\u793A: TermX \u9700\u8981 Obsidian \u684C\u9762\u7248\uFF0C\u4E0D\u652F\u6301\u79FB\u52A8\u7AEF\r
`),e(1)}}write(t){this.pty&&this.pty.write(t)}resize(t,e){if(this.pty)try{this.pty.resize(t,e)}catch(i){}}kill(){this.pty&&(this.pty.kill(),this.pty=null)}get pid(){var t,e;return(e=(t=this.pty)==null?void 0:t.pid)!=null?e:null}getDefaultShellArgs(t){var i,n;let e=(n=(i=t.split(/[\\/]/).pop())==null?void 0:i.toLowerCase())!=null?n:"";return e==="zsh"||e==="bash"||e==="fish"?["-l"]:[]}noticeOnce(t){let e=Date.now();if(!(e-this.lastNoticeAt<2e3)){this.lastNoticeAt=e;try{new W.Notice(t)}catch(i){}}}};function N(s,t){return require("path").join(s,"node_modules",t)}function K(s){return require(N(s,"@xterm/xterm"))}function U(s){return require(N(s,"@xterm/addon-fit"))}function G(s){return require(N(s,"@xterm/addon-search"))}var E=require("obsidian");var L="[\\w./-]",Y=[{name:"http-url",type:"url",pattern:/https?:\/\/[^\s<>"')\]]+/g,extract:(s,t)=>({type:"url",value:s[0],start:t+s.index,end:t+s.index+s[0].length})},{name:"obsidian-protocol",type:"obsidian",pattern:/obsidian:\/\/[^\s<>"')\]]+/g,extract:(s,t)=>({type:"obsidian",value:s[0],start:t+s.index,end:t+s.index+s[0].length})},{name:"wikilink",type:"obsidian",pattern:/\[\[([^\]|]+)(?:\|[^\]]+)?\]\]/g,extract:(s,t)=>({type:"obsidian",value:s[1],start:t+s.index,end:t+s.index+s[0].length})},{name:"email",type:"email",pattern:/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,extract:(s,t)=>({type:"email",value:s[0],start:t+s.index,end:t+s.index+s[0].length})},{name:"file:line:col",type:"file",pattern:new RegExp(`(${L}+\\.\\w+):(\\d+)(?::(\\d+))?`,"g"),extract:(s,t)=>({type:"file",value:s[1],line:parseInt(s[2]),column:s[3]?parseInt(s[3]):void 0,start:t+s.index,end:t+s.index+s[0].length})},{name:"typescript",type:"file",pattern:new RegExp(`(${L}+\\.\\w+)\\((\\d+),(\\d+)\\)`,"g"),extract:(s,t)=>({type:"file",value:s[1],line:parseInt(s[2]),column:parseInt(s[3]),start:t+s.index,end:t+s.index+s[0].length})},{name:"python",type:"file",pattern:/File "([^"]+)", line (\d+)/g,extract:(s,t)=>({type:"file",value:s[1],line:parseInt(s[2]),start:t+s.index,end:t+s.index+s[0].length})},{name:"node-stack",type:"file",pattern:/at (?:\S+ \()?([/\\][\w./\\-]+):(\d+):(\d+)\)?/g,extract:(s,t)=>({type:"file",value:s[1],line:parseInt(s[2]),column:parseInt(s[3]),start:t+s.index+3,end:t+s.index+s[0].length})},{name:"git-status",type:"file",pattern:/(?:modified|deleted|new file):\s+(\S+)/g,extract:(s,t)=>({type:"file",value:s[1],start:t+s.index+s[0].indexOf(s[1]),end:t+s.index+s[0].length})},{name:"relative",type:"file",pattern:new RegExp(`(\\.\\.?/${L}+)`,"g"),extract:(s,t)=>({type:"file",value:s[1],start:t+s.index,end:t+s.index+s[0].length})},{name:"absolute-unix",type:"file",pattern:new RegExp(`(/(?:Users|home|tmp|var|etc)/${L}+\\.\\w+)`,"g"),extract:(s,t)=>({type:"file",value:s[1],start:t+s.index,end:t+s.index+s[0].length})},{name:"windows",type:"file",pattern:/([A-Za-z]:\\[\w.\\-]+)/g,extract:(s,t)=>({type:"file",value:s[1],start:t+s.index,end:t+s.index+s[0].length})}];var M=class{constructor(t){this.terminal=null;this.app=t,this.vaultPath=u(t)}activate(t){this.terminal=t,t.registerLinkProvider({provideLinks:(e,i)=>{let n=t.buffer.active.getLine(e);if(!n){i(void 0);return}let a=n.translateToString(),r=this.findLinks(a,e);i(r.length>0?r:void 0)}})}findLinks(t,e){let i=[];for(let a of Y){a.pattern.lastIndex=0;let r;for(;(r=a.pattern.exec(t))!==null;){let o=a.extract(r,0);o&&i.push(o)}}return this.dedupeMatches(i).map(a=>({range:{start:{x:a.start+1,y:e+1},end:{x:a.end+1,y:e+1}},text:a.value,activate:()=>this.handleClick(a)}))}dedupeMatches(t){let e=t.sort((n,a)=>n.start-a.start),i=[];for(let n of e){let a=i[i.length-1];(!a||n.start>=a.end)&&i.push(n)}return i}async handleClick(t){let{shell:e}=require("electron");switch(t.type){case"url":e.openExternal(t.value);break;case"email":e.openExternal(`mailto:${t.value}`);break;case"obsidian":t.value.startsWith("obsidian://")?window.open(t.value):await this.app.workspace.openLinkText(t.value,"",!1);break;case"file":await this.handleFileClick(t);break}}async handleFileClick(t){let e=this.resolveToVaultFile(t.value);if(e){if(await this.app.workspace.getLeaf(!1).openFile(e),t.line){let n=this.app.workspace.getActiveViewOfType(E.MarkdownView);if(n!=null&&n.editor){let a=t.line-1,r=(t.column||1)-1;n.editor.setCursor({line:a,ch:r}),n.editor.scrollIntoView({from:{line:a,ch:0},to:{line:a,ch:0}},!0)}}}else{let{shell:i}=require("electron");i.openPath(t.value)}}resolveToVaultFile(t){let e=t;t.startsWith(this.vaultPath)&&(e=t.slice(this.vaultPath.length).replace(/^[\/\\]/,""));let i=this.app.vault.getAbstractFileByPath(e);if(i instanceof E.TFile)return i;let n=this.app.vault.getAbstractFileByPath(e+".md");return n instanceof E.TFile?n:null}dispose(){this.terminal=null}};var F=class{constructor(t,e,i,n){this.handleDragOver=t=>this.onDragOver(t);this.handleDrop=t=>{this.onDrop(t)};this.handleDragLeave=t=>this.onDragLeave(t);this.terminal=t,this.container=e,this.app=i,this.writeToShell=n,this.vaultPath=u(i),this.setup()}setup(){this.container.addEventListener("dragover",this.handleDragOver),this.container.addEventListener("drop",this.handleDrop),this.container.addEventListener("dragleave",this.handleDragLeave)}onDragOver(t){t.preventDefault(),t.stopPropagation(),this.container.classList.add("terminal-drag-over"),t.dataTransfer&&(t.dataTransfer.dropEffect="copy")}onDragLeave(t){this.container.classList.remove("terminal-drag-over")}async onDrop(t){if(t.preventDefault(),t.stopPropagation(),this.container.classList.remove("terminal-drag-over"),!t.dataTransfer)return;let e=[];if(t.dataTransfer.files.length>0){let i=null;try{i=require("electron").webUtils}catch(n){}for(let n=0;n<t.dataTransfer.files.length;n++){let a=t.dataTransfer.files[n],r=null;if(i!=null&&i.getPathForFile)try{r=i.getPathForFile(a)}catch(o){}!r&&a.path&&(r=a.path),r&&e.push(r)}}if(e.length===0){let i=t.dataTransfer.getData("text/plain");if(i){let n=this.parseObsidianDrag(i);n&&e.push(this.getFullPath(n))}}if(e.length>0){let i=e.map(n=>this.escapePath(n)).join(" ");this.writeToShell(i)}}parseObsidianDrag(t){if(t.startsWith("obsidian://"))try{let i=new URL(t).searchParams.get("file");if(i){let n=decodeURIComponent(i);return this.findFileByPath(n)}}catch(e){}return this.findFileByPath(t)}findFileByPath(t){let e=this.app.vault.getAbstractFileByPath(t);if(e||(e=this.app.vault.getAbstractFileByPath(t+".md"),e))return e.path;let i=this.app.vault.getAllLoadedFiles();for(let n of i)if(n.name===t||n.name===t+".md")return n.path;return null}getFullPath(t){return require("path").join(this.vaultPath,t)}escapePath(t){return process.platform==="win32"?t.includes(" ")||t.includes("&")||t.includes("^")?`"${t}"`:t:t.includes("'")?`'${t.replace(/'/g,"'\\''")}'`:`'${t}'`}destroy(){this.container.removeEventListener("dragover",this.handleDragOver),this.container.removeEventListener("drop",this.handleDrop),this.container.removeEventListener("dragleave",this.handleDragLeave)}};var f=require("obsidian"),I=class{constructor(t,e,i){this.terminal=t,this.app=e,this.getCursorState=i}getSelection(){return this.terminal.getSelection()}getAllOutput(){let t=this.terminal.buffer.active,e=[];for(let i=0;i<t.length;i++){let n=t.getLine(i);n&&e.push(n.translateToString())}return e.join(`
`)}async sendToNewNote(t){let e=t||this.getSelection();if(!e){new f.Notice("No content selected");return}let i=`Terminal Output ${Date.now()}.md`,n=this.wrapAsCodeBlock(e),a=await this.app.vault.create(i,n);await this.app.workspace.openLinkText(a.path,"",!0),new f.Notice(`Created: ${i}`)}async appendToCurrentNote(t){var m;let e=t||this.getSelection();if(!e){new f.Notice("\u6CA1\u6709\u9009\u4E2D\u5185\u5BB9");return}let i=null,n=null,a=this.getCursorState();if(a){let p=this.app.workspace.getLeavesOfType("markdown");for(let l of p){let S=l.view;if(((m=S.file)==null?void 0:m.path)===a.filePath){i=S,n=a.cursor;break}}}if(i||(i=this.app.workspace.getActiveViewOfType(f.MarkdownView)),!i){let p=this.app.workspace.getLeavesOfType("markdown");p.length>0&&(i=p[0].view)}if(!i){new f.Notice("\u6CA1\u6709\u6253\u5F00\u7684\u7B14\u8BB0");return}let r=i.editor,o=r.getValue(),c="<!-- terminal-output -->",h=o.indexOf(c),g=this.wrapAsCodeBlock(e);if(h!==-1){let p=r.offsetToPos(h+c.length);r.replaceRange(`
`+g+`
`,p),new f.Notice("\u5DF2\u63D2\u5165\u5230\u6807\u8BB0\u4F4D\u7F6E")}else{let p=n||r.getCursor();r.replaceRange(`
`+g+`
`,p),new f.Notice("\u5DF2\u63D2\u5165\u5230\u5149\u6807\u4F4D\u7F6E")}this.app.workspace.setActiveLeaf(i.leaf,{focus:!0})}wrapAsCodeBlock(t){return"```\n"+t.trim()+"\n```"}};function b(s,t,e){try{let i=document.createElement("div");i.style.position="absolute",i.style.left="-99999px",i.style.top="0",i.style.pointerEvents="none",e==="background"?i.style.backgroundColor=`var(${s}, ${t})`:i.style.color=`var(${s}, ${t})`,document.body.appendChild(i);let n=getComputedStyle(i),a=e==="background"?n.backgroundColor:n.color;return i.remove(),(a||"").trim()||t}catch(i){return t}}function Z(s,t){try{let e=document.createElement("div");e.style.position="absolute",e.style.left="-99999px",e.style.top="0",e.style.pointerEvents="none",e.style.fontFamily=`var(${s}, ${t})`,document.body.appendChild(e);let n=getComputedStyle(e).fontFamily||"";return e.remove(),n.trim()||t}catch(e){return t}}function J(s,t,e,i){try{let n=document.createElement("div");n.style.position="absolute",n.style.left="-99999px",n.style.top="0",n.style.pointerEvents="none",n.style.fontFamily=t,n.style.fontSize=`${e}px`,n.style.lineHeight=`var(${s}, ${i})`,document.body.appendChild(n);let a=getComputedStyle(n),r=parseFloat(a.lineHeight||""),o=parseFloat(a.fontSize||"");if(n.remove(),!Number.isFinite(r)||!Number.isFinite(o)||o<=0)return i;let c=r/o;return!Number.isFinite(c)||c<=0?i:Math.min(Math.max(c,1),2)}catch(n){return i}}function Q(){let s=document.body.classList.contains("theme-dark"),t=b("--text-selection",s?"rgba(255,255,255,0.35)":"rgba(0,0,0,0.25)","background"),e=b("--text-on-accent",s?"#1e1e1e":"#ffffff","color");return s?{background:b("--background-primary","#1e1e1e","background"),foreground:b("--text-normal","#d4d4d4","color"),cursor:b("--text-normal","#d4d4d4","color"),selectionBackground:t,selectionForeground:e,black:"#000000",red:"#cd3131",green:"#0dbc79",yellow:"#e5e510",blue:"#2472c8",magenta:"#bc3fbc",cyan:"#11a8cd",white:"#e5e5e5",brightBlack:"#666666",brightRed:"#f14c4c",brightGreen:"#23d18b",brightYellow:"#f5f543",brightBlue:"#3b8eea",brightMagenta:"#d670d6",brightCyan:"#29b8db",brightWhite:"#ffffff"}:{background:b("--background-primary","#fafafa","background"),foreground:b("--text-normal","#383a42","color"),cursor:b("--text-normal","#383a42","color"),selectionBackground:t,selectionForeground:e,black:"#000000",red:"#e45649",green:"#50a14f",yellow:"#c18401",blue:"#4078f2",magenta:"#a626a4",cyan:"#0184bc",white:"#fafafa",brightBlack:"#4a4a4a",brightRed:"#e06c75",brightGreen:"#98c379",brightYellow:"#d19a66",brightBlue:"#61afef",brightMagenta:"#c678dd",brightCyan:"#56b6c2",brightWhite:"#ffffff"}}var A=class{constructor(t,e,i,n,a,r){this.dragDropHandler=null;this.onDataDisposable=null;this.onResizeDisposable=null;this.onSelectionDisposable=null;this.pasteHandler=null;this.exited=!1;this.cwdOverride=null;var $;this.id=a,this.app=t,this.settings=e,this.pluginDir=i,this.getCursorState=n,this.cwdOverride=r!=null?r:null,this.initialCwd=r!=null?r:u(t);let o=e.theme==="auto"?Q():k[e.theme]||k.dark,{Terminal:c}=K(this.pluginDir),{FitAddon:h}=U(this.pluginDir),{SearchAddon:g}=G(this.pluginDir),m=Z("--font-monospace",(($=e.fontFamily)==null?void 0:$.trim())||w.fontFamily),p=J("--line-height-normal",m,e.fontSize,1.15),l=Math.min(Math.max(e.lineHeightScale||1,.8),1.2),S=p*l;this.terminal=new c({fontSize:e.fontSize,fontFamily:m,cursorStyle:e.cursorStyle,cursorBlink:!0,scrollback:e.scrollback,theme:o,letterSpacing:0,lineHeight:S}),this.fitAddon=new h,this.searchAddon=new g,this.pathLinker=new M(t),this.ptyManager=new P(t,e,i),this.terminal.loadAddon(this.fitAddon),this.terminal.loadAddon(this.searchAddon),this.terminal.loadAddon(this.pathLinker),this.contentBridge=new I(this.terminal,t,this.getCursorState),this.terminal.attachCustomKeyEventHandler(v=>{if(v.type!=="keydown")return!0;if(v.metaKey&&v.key==="Backspace")return this.ptyManager.write(""),!1;if(!v.metaKey)return!0;let q=v.key.toLowerCase();if(q==="c"){let X=this.terminal.getSelection();return X?(navigator.clipboard.writeText(X).catch(()=>null),!1):!0}return q==="k"?(this.ptyManager.write("\f"),!1):!0}),this.onSelectionDisposable=this.terminal.onSelectionChange(()=>{if(!this.settings.copyOnSelect)return;let v=this.terminal.getSelection();v&&navigator.clipboard.writeText(v).catch(()=>null)})}async mount(t){this.container=t,this.terminal.open(t),this.fitAddon.fit(),t.addEventListener("mouseup",e=>{this.terminal.getSelection()||(e.target===t||t.contains(e.target))&&this.terminal.focus()}),this.pasteHandler=e=>{e.preventDefault(),e.stopPropagation()},t.addEventListener("paste",this.pasteHandler),this.dragDropHandler=new F(this.terminal,t,this.app,e=>this.ptyManager.write(e)),await this.startPty()}async startPty(){var i;let{cols:t,rows:e}=this.terminal;this.onDataDisposable&&(this.onDataDisposable.dispose(),this.onDataDisposable=null),this.onResizeDisposable&&(this.onResizeDisposable.dispose(),this.onResizeDisposable=null),await this.ptyManager.spawn(n=>this.terminal.write(n),n=>{this.exited=!0,this.terminal.writeln(`\r
[\u8FDB\u7A0B\u5DF2\u9000\u51FA: ${n}]`)},t,e,(i=this.cwdOverride)!=null?i:void 0),this.onDataDisposable=this.terminal.onData(n=>this.ptyManager.write(n)),this.onResizeDisposable=this.terminal.onResize(({cols:n,rows:a})=>this.ptyManager.resize(n,a))}applySettings(t){var o;this.settings=t;let e=Z("--font-monospace",((o=t.fontFamily)==null?void 0:o.trim())||w.fontFamily),i=J("--line-height-normal",e,t.fontSize,1.15),n=Math.min(Math.max(t.lineHeightScale||1,.8),1.2),a=i*n;this.terminal.options.fontSize=t.fontSize,this.terminal.options.fontFamily=e,this.terminal.options.cursorStyle=t.cursorStyle,this.terminal.options.scrollback=t.scrollback,this.terminal.options.lineHeight=a;let r=t.theme==="auto"?Q():k[t.theme]||k.dark;this.terminal.options.theme=r,this.fitAddon.fit()}async restart(t){typeof t!="undefined"&&(this.cwdOverride=t),this.exited=!1,this.ptyManager.kill(),this.terminal.reset(),await this.startPty(),this.terminal.focus()}fit(){this.fitAddon.fit()}writeToShell(t){this.ptyManager.write(t)}show(){var t;(t=this.container)==null||t.classList.remove("hidden"),this.fit(),this.terminal.focus()}hide(){var t;(t=this.container)==null||t.classList.add("hidden")}isExited(){return this.exited}serialize(){return{id:this.id,cwd:this.initialCwd}}dispose(){var t,e,i,n,a;this.ptyManager.kill(),(t=this.dragDropHandler)==null||t.destroy(),(e=this.onDataDisposable)==null||e.dispose(),(i=this.onResizeDisposable)==null||i.dispose(),(n=this.onSelectionDisposable)==null||n.dispose(),this.pasteHandler&&this.container&&this.container.removeEventListener("paste",this.pasteHandler),this.pathLinker.dispose(),this.terminal.dispose(),(a=this.container)==null||a.remove()}};var y="integrated-terminal",z=class extends x.Modal{constructor(t,e){super(t),this.onSearch=e}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("terminal-search-modal");let e=t.createDiv({cls:"terminal-search-input-container"});this.inputEl=e.createEl("input",{type:"text",placeholder:"\u641C\u7D22\u7EC8\u7AEF\u5185\u5BB9...",cls:"terminal-search-input"}),this.inputEl.style.width="100%",this.inputEl.style.padding="8px",this.inputEl.style.marginBottom="10px";let i=t.createDiv({cls:"terminal-search-btns"});i.style.display="flex",i.style.gap="8px";let n=i.createEl("button",{text:"\u4E0A\u4E00\u4E2A"}),a=i.createEl("button",{text:"\u4E0B\u4E00\u4E2A",cls:"mod-cta"});n.onclick=()=>this.doSearch("prev"),a.onclick=()=>this.doSearch("next"),this.inputEl.addEventListener("keydown",r=>{r.key==="Enter"&&(r.preventDefault(),this.doSearch(r.shiftKey?"prev":"next"))}),this.inputEl.focus()}doSearch(t){let e=this.inputEl.value.trim();e&&this.onSearch(e,t)}onClose(){this.contentEl.empty()}},D=class extends x.ItemView{constructor(e,i,n,a,r,o,c){super(e);this.tabs=[];this.activeTab=null;this.tabBar=null;this.terminalArea=null;this.resizeObserver=null;this.getInitialCwd=null;this.bodyClassObserver=null;this.pendingSession=null;this.onSessionChange=null;this.sessionSaveTimer=null;this.settings=i,this.pluginDir=n,this.getCursorState=a,this.getInitialCwd=r!=null?r:null,this.pendingSession=o!=null?o:null,this.onSessionChange=c!=null?c:null}getNextTabId(){let e=new Set(this.tabs.map(n=>n.id)),i=1;for(;e.has(i);)i++;return i}getViewType(){return y}getDisplayText(){return"\u7EC8\u7AEF"}getIcon(){return"terminal-square"}async onOpen(){var i,n;let e=this.containerEl.children[1];if(e.empty(),e.addClass("terminal-view-container"),this.tabBar=e.createDiv({cls:"terminal-tab-bar"}),this.terminalArea=e.createDiv({cls:"terminal-area"}),this.resizeObserver=new ResizeObserver(()=>{var a;return(a=this.activeTab)==null?void 0:a.fit()}),this.resizeObserver.observe(this.terminalArea),this.bodyClassObserver=new MutationObserver(()=>{this.settings.theme==="auto"&&this.tabs.forEach(a=>a.applySettings(this.settings))}),this.bodyClassObserver.observe(document.body,{attributes:!0,attributeFilter:["class"]}),this.pendingSession&&this.pendingSession.tabs.length>0)await this.restoreSession(this.pendingSession),this.pendingSession=null;else{let a=(n=(i=this.getInitialCwd)==null?void 0:i.call(this))!=null?n:null;await this.createTab(a!=null?a:void 0)}}getCurrentFileCwd(){var a;let e=this.app.workspace.getActiveFile();if(!e)return null;let i=((a=e.parent)==null?void 0:a.path)||"",n=u(this.app);return n?require("path").join(n,i):null}async createTab(e){if(!this.terminalArea)return;let i=this.getNextTabId(),n=new A(this.app,this.settings,this.pluginDir,this.getCursorState,i,e!=null?e:null);this.tabs.push(n);let a=this.terminalArea.createDiv({cls:"terminal-wrapper"});await n.mount(a),this.setupContextMenu(n,a),this.switchTab(n),this.renderTabBar(),this.scheduleSessionSave()}switchTab(e,i=!1){this.tabs.forEach(n=>n.hide()),e.show(),this.activeTab=e,i||this.scheduleSessionSave()}renderTabBar(){if(!this.tabBar)return;this.tabBar.empty();let e=this.tabBar.createDiv({cls:"terminal-tabs"}),i=this.tabs.length>1;this.tabs.forEach(r=>{let o=e.createDiv({cls:"terminal-tab"});r===this.activeTab&&o.addClass("active");let c=o.createSpan({text:`\u7EC8\u7AEF ${r.id}`});if(r.isExited()&&c.addClass("exited"),o.onclick=()=>{this.switchTab(r),this.renderTabBar()},i){let h=o.createSpan({text:"\xD7",cls:"tab-close"});h.onclick=g=>{g.stopPropagation(),this.closeTab(r)}}});let n=e.createDiv({cls:"terminal-tab-add"});n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',n.title="\u65B0\u5EFA\u6807\u7B7E",n.onclick=()=>void this.createTab();let a=this.tabBar.createDiv({cls:"terminal-tab-search"});a.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>',a.title="\u641C\u7D22",a.onclick=()=>this.showSearch()}closeTab(e){if(this.tabs.length<=1)return;let i=this.tabs.indexOf(e);i!==-1&&(e.dispose(),this.tabs.splice(i,1),e===this.activeTab&&this.switchTab(this.tabs[Math.min(i,this.tabs.length-1)]),this.renderTabBar(),this.scheduleSessionSave())}setupContextMenu(e,i){i.addEventListener("contextmenu",n=>{n.preventDefault();let a=new x.Menu;a.addItem(r=>r.setTitle("\u590D\u5236").setIcon("copy").onClick(()=>{let o=e.terminal.getSelection();o&&navigator.clipboard.writeText(o)})),a.addItem(r=>r.setTitle("\u7C98\u8D34").setIcon("clipboard-paste").onClick(async()=>{let o=await navigator.clipboard.readText();e.writeToShell(o)})),a.addSeparator(),a.addItem(r=>r.setTitle("\u6E05\u5C4F").setIcon("trash-2").onClick(()=>{e.terminal.clear()})),a.addItem(r=>r.setTitle("\u641C\u7D22").setIcon("search").onClick(()=>{this.showSearch()})),a.addSeparator(),a.addItem(r=>r.setTitle("\u5728\u5F53\u524D\u6587\u4EF6\u76EE\u5F55\u65B0\u5EFA").setIcon("folder-plus").onClick(()=>{let o=this.getCurrentFileCwd();this.createTab(o!=null?o:void 0)})),a.addItem(r=>r.setTitle("\u91CD\u542F\u7EC8\u7AEF").setIcon("refresh-cw").onClick(()=>{this.restartCurrentTab()})),a.addSeparator(),a.addItem(r=>r.setTitle("\u9009\u4E2D\u2192\u65B0\u7B14\u8BB0").setIcon("file-plus").onClick(()=>{e.contentBridge.sendToNewNote()})),a.addItem(r=>r.setTitle("\u9009\u4E2D\u2192\u5F53\u524D\u7B14\u8BB0").setIcon("file-input").onClick(()=>{e.contentBridge.appendToCurrentNote()})),a.showAtMouseEvent(n)})}showSearch(){new z(this.app,(e,i)=>{var n,a;i==="next"?(n=this.activeTab)==null||n.searchAddon.findNext(e):(a=this.activeTab)==null||a.searchAddon.findPrevious(e)}).open()}async createNewTab(e){await this.createTab(e)}async restartCurrentTab(){this.activeTab&&await this.activeTab.restart()}updateSettings(e){this.settings=e,this.tabs.forEach(i=>i.applySettings(e))}closeCurrentTab(){this.activeTab&&this.closeTab(this.activeTab)}clearTerminal(){var e;(e=this.activeTab)==null||e.terminal.clear()}sendToTerminal(e){!e||!this.activeTab||this.activeTab.writeToShell(e)}sendSelectionToNote(){var e;(e=this.activeTab)==null||e.contentBridge.appendToCurrentNote()}getSession(){var e,i;return{version:1,tabs:this.tabs.map(n=>n.serialize()),activeTabId:(i=(e=this.activeTab)==null?void 0:e.id)!=null?i:1}}async restoreSession(e){if(e.tabs.length===0)return;for(let n of e.tabs)await this.createTabWithId(n.id,n.cwd);let i=this.tabs.find(n=>n.id===e.activeTabId);i&&this.switchTab(i,!0),this.renderTabBar()}scheduleSessionSave(){this.sessionSaveTimer&&clearTimeout(this.sessionSaveTimer),this.sessionSaveTimer=setTimeout(()=>{this.onSessionChange&&this.tabs.length>0&&this.onSessionChange(this.getSession()),this.sessionSaveTimer=null},500)}async createTabWithId(e,i){if(!this.terminalArea)return;let n=new A(this.app,this.settings,this.pluginDir,this.getCursorState,e,i!=null?i:null);this.tabs.push(n);let a=this.terminalArea.createDiv({cls:"terminal-wrapper"});await n.mount(a),this.setupContextMenu(n,a),this.activeTab||this.switchTab(n)}async onClose(){var e,i;this.sessionSaveTimer&&(clearTimeout(this.sessionSaveTimer),this.sessionSaveTimer=null),this.onSessionChange&&this.tabs.length>0&&this.onSessionChange(this.getSession()),(e=this.resizeObserver)==null||e.disconnect(),(i=this.bodyClassObserver)==null||i.disconnect(),this.tabs.forEach(n=>n.dispose())}};var d=require("obsidian");var T="var(--font-monospace, monospace)",R={system:{label:"\u8DDF\u968F Obsidian (\u7B49\u5BBD\u5B57\u4F53)",stack:T},sfmono:{label:"SF Mono (macOS)",stack:`'SF Mono', ${T}`},menlo:{label:"Menlo",stack:`'Menlo', ${T}`},monaco:{label:"Monaco",stack:`'Monaco', ${T}`},jetbrains:{label:"JetBrains Mono",stack:`'JetBrains Mono', ${T}`},firacode:{label:"Fira Code",stack:`'Fira Code', ${T}`},cascadia:{label:"Cascadia Code",stack:`'Cascadia Code', ${T}`},sourcecodepro:{label:"Source Code Pro",stack:`'Source Code Pro', ${T}`}};function re(s){let t=(s||"").trim();for(let[e,i]of Object.entries(R))if(i.stack===t)return e;return t==='Menlo, Monaco, "Courier New", monospace'?"menlo":t===""||t==="monospace"?"system":"menlo"}var V=class extends d.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h3",{text:"\u5916\u89C2"}),new d.Setting(t).setName("\u914D\u8272\u4E3B\u9898").addDropdown(e=>e.addOption("auto","\u8DDF\u968F Obsidian").addOption("dark","\u6DF1\u8272").addOption("light","\u6D45\u8272").addOption("dracula","Dracula").addOption("monokai","Monokai").setValue(this.plugin.settings.theme).onChange(async i=>{this.plugin.settings.theme=i,await this.plugin.saveSettings()})),new d.Setting(t).setName("\u5B57\u4F53").addDropdown(e=>{for(let[i,n]of Object.entries(R))e.addOption(i,n.label);e.setValue(re(this.plugin.settings.fontFamily)).onChange(async i=>{let n=R[i];n&&(this.plugin.settings.fontFamily=n.stack,await this.plugin.saveSettings())})}),new d.Setting(t).setName("\u5B57\u4F53\u5927\u5C0F").addSlider(e=>e.setLimits(10,24,1).setValue(this.plugin.settings.fontSize).setDynamicTooltip().onChange(async i=>{this.plugin.settings.fontSize=i,await this.plugin.saveSettings()})),new d.Setting(t).setName("\u5149\u6807\u6837\u5F0F").addDropdown(e=>e.addOption("block","\u65B9\u5757").addOption("underline","\u4E0B\u5212\u7EBF").addOption("bar","\u7AD6\u7EBF").setValue(this.plugin.settings.cursorStyle).onChange(async i=>{this.plugin.settings.cursorStyle=i,await this.plugin.saveSettings()})),new d.Setting(t).setName("\u884C\u9AD8\u6BD4\u4F8B").setDesc("\u57FA\u4E8E Obsidian \u884C\u9AD8\u7684\u7F29\u653E\u7CFB\u6570\uFF0C\u5EFA\u8BAE\u8303\u56F4 0.90-1.05").addSlider(e=>e.setLimits(.85,1.2,.01).setValue(this.plugin.settings.lineHeightScale).setDynamicTooltip().onChange(async i=>{this.plugin.settings.lineHeightScale=i,await this.plugin.saveSettings()})),t.createEl("h3",{text:"\u884C\u4E3A"}),new d.Setting(t).setName("\u9009\u4E2D\u81EA\u52A8\u590D\u5236").setDesc("\u9009\u4E2D\u6587\u672C\u65F6\u81EA\u52A8\u590D\u5236\u5230\u526A\u8D34\u677F").addToggle(e=>e.setValue(this.plugin.settings.copyOnSelect).onChange(async i=>{this.plugin.settings.copyOnSelect=i,await this.plugin.saveSettings()})),new d.Setting(t).setName("\u6062\u590D\u4F1A\u8BDD").setDesc("\u91CD\u542F Obsidian \u540E\u6062\u590D\u7EC8\u7AEF\u6807\u7B7E\u548C\u5DE5\u4F5C\u76EE\u5F55").addToggle(e=>e.setValue(this.plugin.settings.restoreSession).onChange(async i=>{this.plugin.settings.restoreSession=i,i||this.plugin.clearSavedSession(),await this.plugin.saveSettings()})),new d.Setting(t).setName("\u6EDA\u52A8\u7F13\u51B2\u884C\u6570").setDesc("\u7EC8\u7AEF\u4FDD\u7559\u7684\u5386\u53F2\u884C\u6570").addSlider(e=>e.setLimits(1e3,5e4,1e3).setValue(this.plugin.settings.scrollback).setDynamicTooltip().onChange(async i=>{this.plugin.settings.scrollback=i,await this.plugin.saveSettings()})),t.createEl("h3",{text:"\u542F\u52A8"}),t.createEl("p",{text:"\u4EE5\u4E0B\u8BBE\u7F6E\u9700\u8981\u91CD\u542F\u7EC8\u7AEF\u6216\u65B0\u5EFA\u6807\u7B7E\u624D\u4F1A\u751F\u6548",cls:"setting-item-description"}),new d.Setting(t).setName("Shell \u7A0B\u5E8F").setDesc(`\u7559\u7A7A\u4F7F\u7528\u7CFB\u7EDF\u9ED8\u8BA4: ${C()}`).addText(e=>{e.inputEl.style.width="200px",e.setPlaceholder(C()).setValue(this.plugin.settings.shell).onChange(async i=>{this.plugin.settings.shell=i,await this.plugin.saveSettings()})}),new d.Setting(t).setName("\u9ED8\u8BA4\u5DE5\u4F5C\u76EE\u5F55").addDropdown(e=>e.addOption("vault","Vault \u6839\u76EE\u5F55").addOption("home","\u7528\u6237\u4E3B\u76EE\u5F55").addOption("custom","\u81EA\u5B9A\u4E49\u8DEF\u5F84").setValue(this.plugin.settings.defaultCwd).onChange(async i=>{this.plugin.settings.defaultCwd=i,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.defaultCwd==="custom"&&new d.Setting(t).setName("\u81EA\u5B9A\u4E49\u8DEF\u5F84").addText(e=>e.setPlaceholder("/path/to/directory").setValue(this.plugin.settings.customCwd).onChange(async i=>{this.plugin.settings.customCwd=i,await this.plugin.saveSettings()})),new d.Setting(t).addButton(e=>e.setButtonText("\u91CD\u542F\u5F53\u524D\u7EC8\u7AEF").onClick(async()=>{await this.plugin.restartActiveTerminal()}))}};var O=class extends B.Plugin{constructor(){super(...arguments);this.settings=w;this.session=null;this.pendingInitialCwd=null;this.lastCursorState=null;this.cursorTrackEvents=[]}getPluginDir(){return require("path").join(u(this.app),".obsidian","plugins",this.manifest.id)}async onload(){await this.loadSettings();let e=this.getPluginDir();this.setupCursorTracking(),this.registerView(y,i=>{let n=this.settings.restoreSession?this.consumeSession():null;return new D(i,this.settings,e,()=>this.lastCursorState,()=>this.consumePendingInitialCwd(),n,a=>this.saveSession(a))}),this.addCommand({id:"open-terminal",name:"\u6253\u5F00\u7EC8\u7AEF",callback:()=>this.activateView()}),this.addCommand({id:"toggle-terminal",name:"\u5207\u6362\u7EC8\u7AEF (\u663E\u793A/\u9690\u85CF)",callback:()=>this.toggleTerminal()}),this.addCommand({id:"open-terminal-here",name:"\u5728\u5F53\u524D\u6587\u4EF6\u76EE\u5F55\u6253\u5F00\u7EC8\u7AEF",callback:()=>this.openTerminalAtCurrentFile()}),this.addCommand({id:"send-selection-to-terminal",name:"\u53D1\u9001\u9009\u4E2D\u5185\u5BB9\u5230\u7EC8\u7AEF",editorCallback:i=>{let n=i.getSelection();n&&this.sendToTerminal(n)}}),this.addCommand({id:"new-terminal-tab",name:"\u65B0\u5EFA\u7EC8\u7AEF\u6807\u7B7E",callback:()=>{var i;return(i=this.getTerminalView())==null?void 0:i.createNewTab()}}),this.addCommand({id:"close-terminal-tab",name:"\u5173\u95ED\u5F53\u524D\u7EC8\u7AEF\u6807\u7B7E",callback:()=>{var i;return(i=this.getTerminalView())==null?void 0:i.closeCurrentTab()}}),this.addCommand({id:"clear-terminal",name:"\u6E05\u5C4F",callback:()=>{var i;return(i=this.getTerminalView())==null?void 0:i.clearTerminal()}}),this.addCommand({id:"terminal-search",name:"\u7EC8\u7AEF\u641C\u7D22",callback:()=>{var i;return(i=this.getTerminalView())==null?void 0:i.showSearch()}}),this.addCommand({id:"terminal-selection-to-note",name:"\u7EC8\u7AEF\u9009\u4E2D\u5185\u5BB9 \u2192 \u5F53\u524D\u7B14\u8BB0",callback:()=>{var i;return(i=this.getTerminalView())==null?void 0:i.sendSelectionToNote()}}),this.registerEvent(this.app.workspace.on("editor-menu",(i,n)=>{let a=n.getSelection();a&&i.addItem(r=>{r.setTitle("\u53D1\u9001\u5230\u7EC8\u7AEF").setIcon("terminal").onClick(()=>this.sendToTerminal(a))})})),this.addSettingTab(new V(this.app,this)),this.addRibbonIcon("terminal-square","\u6253\u5F00\u7EC8\u7AEF",()=>this.activateView())}async activateView(){let{workspace:e}=this.app,i=e.getLeavesOfType(y)[0];if(!i){let n=e.getRightLeaf(!1);n&&(i=n,await i.setViewState({type:y,active:!0}))}i&&e.revealLeaf(i)}async openTerminalAtCurrentFile(){var r;let e=this.app.workspace.getActiveFile();if(!e){await this.activateView();return}let i=((r=e.parent)==null?void 0:r.path)||"",n=require("path").join(u(this.app),i),a=this.getTerminalView();if(a){await this.activateView(),await a.createNewTab(n);return}this.pendingInitialCwd=n,await this.activateView()}sendToTerminal(e){let i=this.getTerminalView();i&&i.sendToTerminal(e)}getTerminalView(){let e=this.app.workspace.getLeavesOfType(y);return e.length>0?e[0].view:null}async toggleTerminal(){let e=this.app.workspace.getLeavesOfType(y);if(e.length>0){let i=e[0];this.app.workspace.getActiveViewOfType(D)!==null?i.detach():this.app.workspace.revealLeaf(i)}else await this.activateView()}async loadSettings(){let e=await this.loadData();this.settings=Object.assign({},w,e),this.settings.lineHeightScale||(this.settings.lineHeightScale=w.lineHeightScale),e!=null&&e.session&&(this.session=e.session)}async saveSettings(){await this.saveData({...this.settings,session:this.session}),this.applySettingsToViews()}applySettingsToViews(){let e=this.app.workspace.getLeavesOfType(y);for(let i of e)i.view.updateSettings(this.settings)}async restartActiveTerminal(){var e;await((e=this.getTerminalView())==null?void 0:e.restartCurrentTab())}consumePendingInitialCwd(){let e=this.pendingInitialCwd;return this.pendingInitialCwd=null,e}consumeSession(){let e=this.session;return this.session=null,e}saveSession(e){this.session=e,this.saveData({...this.settings,session:e})}clearSavedSession(){this.session=null}setupCursorTracking(){let e=()=>{let i=this.app.workspace.getActiveViewOfType(B.MarkdownView);i!=null&&i.file&&(this.lastCursorState={filePath:i.file.path,cursor:i.editor.getCursor()})};this.cursorTrackEvents.push(this.app.workspace.on("active-leaf-change",()=>{setTimeout(e,10)})),this.cursorTrackEvents.push(this.app.workspace.on("editor-change",e))}onunload(){this.cursorTrackEvents.forEach(e=>this.app.workspace.offref(e)),this.cursorTrackEvents=[]}};
